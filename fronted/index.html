<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>科研实习智能匹配（功能测试前端）</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto;margin:0;background:#f7f7fb}
    header{background:#2c3e50;color:#fff;padding:16px}
    main{padding:16px;max-width:1100px;margin:auto}
    section{background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:16px;margin-bottom:16px}
    input,textarea,select{width:100%;padding:8px;margin:8px 0;border:1px solid #d1d5db;border-radius:6px}
    button{padding:8px 12px;border:none;border-radius:6px;background:#2563eb;color:#fff;cursor:pointer}
    button:disabled{background:#9ca3af}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #eee;padding:8px;text-align:left}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .muted{color:#6b7280}
    .row{display:flex;gap:12px;align-items:center}
    .code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#f3f4f6;padding:6px 8px;border-radius:6px}
  </style>
</head>
<body>
  <header>
    <h1>校内科研实习供需智能匹配与跟踪管理 - 测试前端</h1>
    <div class="row">
      <div class="muted">后端：<span class="code" id="apiBase">http://localhost:8080</span></div>
      <div class="muted">当前身份：<span class="code" id="who">未登录</span></div>
    </div>
  </header>
  <main>
    <section>
      <h2>注册与登录</h2>
      <div class="grid3">
        <div>
          <h3>注册用户</h3>
          <input id="regName" placeholder="姓名" />
          <input id="regEmail" placeholder="邮箱" />
          <input id="regPass" placeholder="密码" type="password" />
          <select id="regRole">
            <option value="student">学生</option>
            <option value="teacher">教师</option>
            <option value="admin">管理员</option>
          </select>
          <input id="regSkills" placeholder="技能（逗号分隔，学生可填）" />
          <button id="btnRegister">注册</button>
          <div class="muted" id="regInfo"></div>
        </div>
        <div>
          <h3>登录</h3>
          <input id="loginEmail" placeholder="邮箱" />
          <input id="loginPass" placeholder="密码" type="password" />
          <button id="btnLogin">登录</button>
          <div class="muted">Token长度：<span id="tokLen">0</span></div>
        </div>
        <div>
          <h3>用户列表（便于测试）</h3>
          <div class="row">
            <button id="btnListUsers">刷新</button>
            <select id="listRole"><option value="">全部</option><option value="student">学生</option><option value="teacher">教师</option><option value="admin">管理员</option></select>
          </div>
          <div id="users"></div>
        </div>
      </div>
    </section>

    <section>
      <h2>教师：发布与管理项目</h2>
      <div class="grid2">
        <div>
          <h3>发布项目</h3>
          <input id="projTitle" placeholder="项目标题" />
          <textarea id="projDesc" placeholder="项目描述"></textarea>
          <input id="projReq" placeholder="项目要求（逗号分隔）" />
          <input id="projTags" placeholder="项目标签（逗号分隔）" />
          <button id="btnCreateProject">发布项目</button>
        </div>
        <div>
          <h3>项目列表</h3>
          <div class="row"><button id="btnListProjects">刷新</button> <input id="filterTeacherId" placeholder="按教师ID过滤（可选）" /></div>
          <table>
            <thead><tr><th>ID</th><th>标题</th><th>要求</th></tr></thead>
            <tbody id="projects"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section>
      <h2>学生：智能匹配与申请</h2>
      <div class="grid2">
        <div>
          <div class="row"><button id="btnMatch">计算匹配</button> <input id="applyProjectId" placeholder="申请项目ID" /> <button id="btnApply">申请</button></div>
          <table>
            <thead><tr><th>项目</th><th>匹配度</th><th>理由</th><th>操作</th></tr></thead>
            <tbody id="matches"></tbody>
          </table>
        </div>
        <div>
          <h3>成果上传</h3>
          <input id="uploadAppId" placeholder="申请ID" />
          <input id="uploadFile" type="file" />
          <button id="btnUpload">上传</button>
          <div id="uploadInfo" class="muted"></div>
        </div>
      </div>
    </section>

    <section>
      <h2>教师：申请筛选与跟踪、评价</h2>
      <div class="grid2">
        <div>
          <div class="row"><button id="btnListApps">拉取申请</button> <input id="fltProj" placeholder="项目ID（可选）" /> <input id="fltStatus" placeholder="状态（submitted等，可选）" /></div>
          <table>
            <thead><tr><th>申请ID</th><th>项目ID</th><th>学生</th><th>评分</th></tr></thead>
            <tbody id="apps"></tbody>
          </table>
        </div>
        <div>
      <h3>更新进度与提交评价</h3>
      <input id="trackAppId" placeholder="申请ID" />
      <input id="trackProgress" placeholder="进度描述" />
      <button id="btnTrack">更新进度</button>
      <div class="row"><input id="statusAppId" placeholder="申请ID" /> <input id="statusVal" placeholder="状态（accepted/rejected/...）" /> <button id="btnStatus">更新状态</button></div>
      <hr/>
          <input id="fbFrom" placeholder="评价人用户ID（教师）" />
          <input id="fbTo" placeholder="被评价学生ID" />
          <input id="fbAppId" placeholder="申请ID" />
          <input id="fbRating" placeholder="评分（1-5）" />
          <input id="fbComment" placeholder="评语" />
          <button id="btnFeedback">提交评价</button>
        </div>
      </div>
    </section>

    <section>
      <h2>管理员：统计看板</h2>
      <div class="row"><button id="btnStats">拉取统计</button></div>
      <pre class="code" id="stats"></pre>
    </section>
  </main>

  <script>
    const API = document.getElementById('apiBase').textContent;
    let token = '';
    let currentUser = null;

    function authHeaders() {
      return token ? { 'Content-Type':'application/json', 'Authorization':'Bearer '+token } : { 'Content-Type':'application/json' };
    }
    async function jsonFetch(url, opts={}){
      const res = await fetch(url, opts);
      if(!res.ok){ const t=await res.text(); throw new Error(t || res.statusText); }
      return res.json();
    }

    // Auth
    document.getElementById('btnRegister').onclick = async () => {
      const name = regName.value.trim();
      const email = regEmail.value.trim();
      const password = regPass.value.trim();
      const role = regRole.value;
      const skills = regSkills.value.split(',').map(s=>s.trim()).filter(Boolean);
      const body = { name, email, password, role, skills };
      const u = await jsonFetch(API+'/api/auth/register',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
      regInfo.textContent = '注册成功：用户ID '+u.id;
    }
    document.getElementById('btnLogin').onclick = async () => {
      const email = loginEmail.value.trim(); const password = loginPass.value.trim();
      const tok = await jsonFetch(API+'/api/auth/login',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email,password})});
      token = tok.token; tokLen.textContent = token.length;
      // 获取当前用户信息（简单方式：列表里查邮箱）
      const users = await jsonFetch(API+'/api/users');
      currentUser = users.find(u=>u.email===email) || null;
      who.textContent = currentUser ? (currentUser.name+'('+currentUser.role+') #'+currentUser.id) : '已登录';
    }
    document.getElementById('btnListUsers').onclick = async () => {
      const role = listRole.value;
      const list = await jsonFetch(API+'/api/users'+(role?('?role='+role):''));
      users.innerHTML = list.map(u=>`<div class="code">#${u.id} ${u.name} &lt;${u.email}&gt; (${u.role})</div>`).join('');
    }

    // Projects
    document.getElementById('btnCreateProject').onclick = async () => {
      if(!currentUser || (currentUser.role!=='teacher' && currentUser.role!=='admin')){ alert('需教师/管理员登录'); return }
      const teacher_id = currentUser.id;
      const title = projTitle.value.trim(); const description = projDesc.value.trim();
      const requirements = projReq.value.split(',').map(s=>s.trim()).filter(Boolean);
      const tags = projTags.value.split(',').map(s=>s.trim()).filter(Boolean);
      const p = await jsonFetch(API+'/api/projects',{ method:'POST', headers: authHeaders(), body: JSON.stringify({teacher_id,title,description,requirements,tags})});
      alert('已发布项目 #'+p.id);
    }
    document.getElementById('btnListProjects').onclick = async () => {
      const tid = filterTeacherId.value.trim();
      const ps = await jsonFetch(API+'/api/projects'+(tid?('?teacher_id='+tid):''),{ headers: authHeaders() });
      projects.innerHTML = ps.map(p=>`<tr><td>${p.id}</td><td>${p.title}</td><td>${(p.requirements||[]).join(', ')}</td></tr>`).join('');
    }

    // Matching & Apply
    document.getElementById('btnMatch').onclick = async () => {
      if(!currentUser || (currentUser.role!=='student' && currentUser.role!=='admin')){ alert('需学生/管理员登录'); return }
      const ms = await jsonFetch(API+'/api/matches?student_id='+currentUser.id,{ headers: authHeaders() });
      matches.innerHTML = ms.sort((a,b)=>b.score-a.score).map(m=>{
        return `<tr><td>${m.project.title} (#${m.project.id})</td><td>${Math.round(m.score*100)}%</td><td>${m.reason}</td><td><button onclick="applyDirect(${m.project.id})">申请</button></td></tr>`;
      }).join('');
    }
    window.applyDirect = async (pid) => {
      if(!currentUser || currentUser.role!=='student'){ alert('需学生登录'); return }
      const a = await jsonFetch(API+'/api/apply',{ method:'POST', headers: authHeaders(), body: JSON.stringify({student_id: currentUser.id, project_id: pid})});
      alert('申请成功，ID='+a.id);
    }
    document.getElementById('btnApply').onclick = async () => {
      const pid = Number(applyProjectId.value);
      await window.applyDirect(pid);
    }

    // Upload
    document.getElementById('btnUpload').onclick = async () => {
      if(!currentUser || currentUser.role!=='student'){ alert('需学生登录'); return }
      const appId = Number(uploadAppId.value);
      const fileInput = document.getElementById('uploadFile');
      if(!fileInput.files.length){ alert('请选择文件'); return }
      const fd = new FormData(); fd.append('application_id', appId); fd.append('file', fileInput.files[0]);
      const res = await fetch(API+'/api/upload',{ method:'POST', headers:{ 'Authorization': 'Bearer '+token }, body: fd });
      if(!res.ok){ uploadInfo.textContent = await res.text(); return }
      const d = await res.json(); uploadInfo.textContent = '已上传：'+d.name;
      const list = await jsonFetch(API+`/api/documents?application_id=${appId}`,{ headers: authHeaders() });
      uploadInfo.textContent += `（共${list.length}个附件）`;
    }

    // Teacher list applications, tracking & feedback
    document.getElementById('btnListApps').onclick = async () => {
      if(!currentUser || (currentUser.role!=='teacher' && currentUser.role!=='admin')){ alert('需教师/管理员登录'); return }
      const params = [];
      if(fltProj.value.trim()) params.push('project_id='+encodeURIComponent(fltProj.value.trim()));
      if(fltStatus.value.trim()) params.push('status='+encodeURIComponent(fltStatus.value.trim()));
      const url = API+'/api/applications'+(params.length?('?'+params.join('&')):'');
      const views = await jsonFetch(url,{ headers: authHeaders() });
      apps.innerHTML = views.map(v=>`<tr><td>${v.application.id}</td><td>${v.project.id}</td><td>${v.student.name} (#${v.student.id})</td><td>${Math.round((v.score||0)*100)}%</td></tr>`).join('');
    }
    document.getElementById('btnTrack').onclick = async () => {
      if(!currentUser || (currentUser.role!=='teacher' && currentUser.role!=='admin')){ alert('需教师/管理员登录'); return }
      const application_id = Number(trackAppId.value); const progress = trackProgress.value.trim();
      const t = await jsonFetch(API+'/api/tracking',{ method:'POST', headers: authHeaders(), body: JSON.stringify({application_id,progress})});
      alert('更新成功，tracking_id='+t.id);
    }
    document.getElementById('btnFeedback').onclick = async () => {
      if(!currentUser || (currentUser.role!=='teacher' && currentUser.role!=='admin')){ alert('需教师/管理员登录'); return }
      const from_user_id = Number(fbFrom.value), to_user_id = Number(fbTo.value), application_id = Number(fbAppId.value); const rating = Number(fbRating.value); const comment = fbComment.value.trim();
      const f = await jsonFetch(API+'/api/feedback',{ method:'POST', headers: authHeaders(), body: JSON.stringify({from_user_id,to_user_id,application_id,rating,comment})});
      alert('评价成功，id='+f.id);
    }

    // Admin stats
    document.getElementById('btnStats').onclick = async () => {
      if(!currentUser || currentUser.role!=='admin'){ alert('需管理员登录'); return }
      const s = await jsonFetch(API+'/api/admin/stats',{ headers: authHeaders() });
      stats.textContent = JSON.stringify(s,null,2);
    }
    document.getElementById('btnStatus').onclick = async () => {
      if(!currentUser || (currentUser.role!=='teacher' && currentUser.role!=='admin')){ alert('需教师/管理员登录'); return }
      const application_id = Number(statusAppId.value); const status = statusVal.value.trim();
      const r = await jsonFetch(API+'/api/application/status',{ method:'POST', headers: authHeaders(), body: JSON.stringify({application_id,status})});
      alert('状态已更新');
    }
  </script>
</body>
</html>
